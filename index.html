<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-title" content="Levage Sécurisé">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <title>Chantiers Modernes - Levage Sécurisé (Local V9.0)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS pour Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- jsPDF & AutoTable pour PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- Lucide Icons (via unpkg pour React) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { blue: '#004e98', red: '#d92e2e', dark: '#0f172a' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* Custom Range Slider Styling (Original conservé) */
        input[type=range] { 
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
            height: 24px; 
            cursor: pointer;
        }
        
        input[type=range]:focus { outline: none; }

        /* Thumb styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #004e98;
            cursor: pointer;
            margin-top: -10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid white;
            position: relative;
            z-index: 20;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useMemo, useEffect, useRef } = React;
        const { jsPDF } = window.jspdf; // Accès à jsPDF

        // --- ICONS (SVG inline simple) ---
        const IconWrapper = ({ size = 24, className, children, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Icons = {
            Calculator: (p) => <IconWrapper {...p}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>,
            CheckCircle: (p) => <IconWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>,
            Truck: (p) => <IconWrapper {...p}><rect x="1" y="3" width="15" height="13" rx="2" ry="2"/><polyline points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></IconWrapper>,
            Anchor: (p) => <IconWrapper {...p}><circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></IconWrapper>,
            Move: (p) => <IconWrapper {...p}><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></IconWrapper>,
            Upload: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>,
            Download: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>,
            ArrowLeft: (p) => <IconWrapper {...p}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconWrapper>,
            Trash2: (p) => <IconWrapper {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconWrapper>,
            Database: (p) => <IconWrapper {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            FileJson: (p) => <IconWrapper {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconWrapper>,
            FileText: (p) => <IconWrapper {...p}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconWrapper>
        };

        const { Calculator, CheckCircle, Truck, Anchor, Move, Upload, Download, ArrowLeft, Trash2, Database, Save, FileJson, FileText } = Icons;

        // --- CONSTANTES ---
        const DB_KEY = "cmc_levage_machines"; // Clé LocalStorage BDD
        const SELECTED_CRANE_KEY = "selectedCrane"; // Clé LocalStorage Grue choisie

        // --- DONNÉES STATIQUES (Originales) ---
        const HARDCODED_MACHINES = [
            {
                id: "fixed_1",
                category: "telehandler", 
                name: "Manitou MLT 625-75H",
                type: "telehandler", 
                mode: "zone",
                maxLoad: 2500,
                maxReach: 3.30, 
                maxHeight: 5.90,
                zones: [
                    { id: '2500kg', load: 2500, color: 'rgba(22, 163, 74, 0.4)', borderColor: 'rgba(22, 163, 74, 1)', points: [[0,0], [1.1,0], [1.1,1.5], [0.9,3.0], [0.5,4.5], [0,5.5]] },
                    { id: '2000kg', load: 2000, color: 'rgba(34, 197, 94, 0.3)', borderColor: 'rgba(34, 197, 94, 1)', points: [[1.1,0], [1.7,0], [1.7,1.2], [1.5,3.0], [1.2,5.5], [0.6,5.9], [0,5.9], [0,4.5], [0.5,4.5], [0.9,3.0], [1.1,1.5]] },
                    { id: '1500kg', load: 1500, color: 'rgba(234, 179, 8, 0.3)', borderColor: 'rgba(234, 179, 8, 1)', points: [[1.7,0], [2.2,0], [2.2,0.8], [1.9,2.5], [1.5,3.0], [1.2,5.5], [1.5,3.0], [1.7,1.2]] },
                    { id: '1000kg', load: 1000, color: 'rgba(249, 115, 22, 0.3)', borderColor: 'rgba(249, 115, 22, 1)', points: [[2.2,0], [2.85,0], [2.85,0.5], [2.3,2.0], [1.9,2.5], [2.2,0.8]] },
                    { id: '800kg', load: 800, color: 'rgba(239, 68, 68, 0.3)', borderColor: 'rgba(239, 68, 68, 1)', points: [[2.85,0], [3.15,0], [3.3,0.5], [3.15,2], [3.10,2.5], [2.85,3.25]] }
                ]
            },
            {
                id: "fixed_2",
                category: "mobile_crane",
                name: "Liebherr LTM 1050-3.1",
                type: "crane",
                mode: "multi_chart",
                maxLoad: 50000,
                maxReach: 34,
                maxHeight: 40,
                hasTelescoping: true, 
                boomLengths: [11.4, 16.7, 22, 27.3, 32.6, 35.8, 38],
                charts: {
                "11.4": { std: [{d:3, l:50}, {d:4, l:41.3}, {d:5, l:24.1}, {d:6, l:29}, {d:7, l:24.5}, {d:8, l:16.8}], tele: [{d:3, l:42}, {d:4, l:36.5}, {d:5, l:30.6}, {d:6, l:25.5}, {d:7, l:21.5}, {d:8, l:16.8}] },
                "16.7": { std: [{d:3, l:24.7}, {d:4, l:26.5}, {d:5, l:27.8}, {d:6, l:26}, {d:7, l:21.8}, {d:8, l:18.5}, {d:9, l:15.5}, {d:10, l:13.1}, {d:11, l:11.4}, {d:12, l:10}], tele: [{d:3, l:20.2}, {d:4, l:20.2}, {d:5, l:20.2}, {d:6, l:20.2}, {d:7, l:20.2}, {d:8, l:18.5}, {d:9, l:15.5}, {d:10, l:13.1}, {d:11, l:11.4}, {d:12, l:10}] },
                "22": { std: [{d:3, l:24.6}, {d:4, l:25.1}, {d:5, l:24.2}, {d:6, l:22.7}, {d:7, l:21}, {d:8, l:18.6}, {d:9, l:15.6}, {d:10, l:13.4}, {d:11, l:11.5}, {d:12, l:10.1}, {d:14, l:7.8}, {d:16, l:6.3}, {d:18, l:5.2}], tele: [{d:3, l:19.1}, {d:4, l:18.9}, {d:5, l:18.8}, {d:6, l:18.7}, {d:7, l:18.6}, {d:8, l:18.2}, {d:9, l:15.6}, {d:10, l:13.4}, {d:11, l:11.5}, {d:12, l:10.1}, {d:14, l:7.8}, {d:16, l:6.3}, {d:18, l:5.2}] },
                "27.3": { std: [{d:3, l:17}, {d:4, l:16.6}, {d:5, l:16}, {d:6, l:15.3}, {d:7, l:14.4}, {d:8, l:13.4}, {d:9, l:12.5}, {d:10, l:11.6}, {d:11, l:10.8}, {d:12, l:10.1}, {d:14, l:7.8}, {d:16, l:6.4}, {d:18, l:5.3}, {d:20, l:4.3}, {d:22, l:3.6}, {d:24, l:3}], tele: [{d:3, l:15.8}, {d:4, l:15.5}, {d:5, l:15.2}, {d:6, l:15}, {d:7, l:14.4}, {d:8, l:13.4}, {d:9, l:12.5}, {d:10, l:11.6}, {d:11, l:10.8}, {d:12, l:10.1}, {d:14, l:7.8}, {d:16, l:6.4}, {d:18, l:5.3}, {d:20, l:4.3}, {d:22, l:3.6}, {d:24, l:3}] },
                "32.6": { std: [{d:4, l:11.5}, {d:5, l:11.3}, {d:6, l:11}, {d:7, l:10.7}, {d:8, l:10.2}, {d:9, l:9.7}, {d:10, l:9.2}, {d:11, l:8.6}, {d:12, l:8}, {d:14, l:7.1}, {d:16, l:6.4}, {d:18, l:5.4}, {d:20, l:4.4}, {d:22, l:3.7}, {d:24, l:3.1}, {d:26, l:2.7}, {d:28, l:2.2}], tele: [{d:4, l:10.7}, {d:5, l:10.3}, {d:6, l:10}, {d:7, l:9.7}, {d:8, l:9.4}, {d:9, l:9.2}, {d:10, l:8.8}, {d:11, l:8.1}, {d:12, l:7.9}, {d:14, l:7.1}, {d:16, l:6.4}, {d:18, l:5.4}, {d:20, l:4.4}, {d:22, l:3.7}, {d:24, l:3.1}, {d:26, l:2.7}, {d:28, l:2.2}] },
                "35.8": { std: [{d:5, l:9.5}, {d:6, l:9.4}, {d:7, l:9.2}, {d:8, l:8.9}, {d:9, l:8.5}, {d:10, l:8.1}, {d:11, l:7.7}, {d:12, l:7.3}, {d:14, l:6.7}, {d:16, l:6.1}, {d:18, l:5.4}, {d:20, l:4.3}, {d:22, l:3.7}, {d:24, l:3.1}, {d:26, l:2.7}, {d:28, l:2.3}, {d:30, l:1.9}, {d:32, l:1.6}], tele: [{d:5, l:6.9}, {d:6, l:6.6}, {d:7, l:6.3}, {d:8, l:6.1}, {d:9, l:5.8}, {d:10, l:5.6}, {d:11, l:5.4}, {d:12, l:5.2}, {d:14, l:4.9}, {d:16, l:4.6}, {d:18, l:4}, {d:20, l:3.7}, {d:22, l:3.2}, {d:24, l:2.4}, {d:26, l:1.8}, {d:28, l:1.4}, {d:30, l:1}] },
                "38": { std: [{d:6, l:7.5}, {d:7, l:7.2}, {d:8, l:7}, {d:9, l:6.7}, {d:10, l:6.5}, {d:11, l:6.2}, {d:12, l:6}, {d:14, l:5.6}, {d:16, l:5.2}, {d:18, l:4.8}, {d:20, l:4.3}, {d:22, l:3.7}, {d:24, l:3.2}, {d:26, l:2.7}, {d:28, l:2.3}, {d:30, l:1.9}, {d:32, l:1.6}, {d:34, l:1.4}], tele: [{d:6, l:3.7}, {d:7, l:3.5}, {d:8, l:3.3}, {d:9, l:3.2}, {d:10, l:3}, {d:11, l:2.8}, {d:12, l:2.7}, {d:14, l:2.5}, {d:16, l:2.3}, {d:18, l:1.7}, {d:20, l:1.3}, {d:22, l:0.9}] }
                }
            }
        ];

        // --- UTILITAIRES ---
        const isPointInPolygon = (x, y, polygon) => {
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][0], yi = polygon[i][1];
                const xj = polygon[j][0], yj = polygon[j][1];
                const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        };

        // --- LOGIQUE DE CALCUL CENTRALE (Pour auto-sélection et vérification) ---
        const calculateMachineCapacity = (machine, dist, height, specificBoom = null) => {
            if (!machine) return 0;
            
            // 1. Vérif Enveloppe
            if (dist > machine.maxReach || height > machine.maxHeight) return 0;

            if (machine.mode === 'multi_chart') {
                const checkBoom = (boomLen) => {
                    const reqReachSq = (dist * dist) + (height * height);
                    if (reqReachSq > (boomLen * boomLen) + 0.1) return 0; // Hors de portée physique de la flèche
                    
                    const points = machine.charts[boomLen]?.std;
                    if (!points || points.length === 0) return 0;
                    if (dist > points[points.length - 1].d) return 0; // Trop loin
                    if (dist < points[0].d) return machine.maxLoad; // Trop près (théorique)

                    for (let i = 0; i < points.length - 1; i++) {
                        const p1 = points[i];
                        const p2 = points[i+1];
                        if (dist >= p1.d && dist <= p2.d) {
                             const slope = (p2.l - p1.l) / (p2.d - p1.d);
                             const interpolated = p1.l + slope * (dist - p1.d);
                             return Math.floor(interpolated * 1000); 
                        }
                    }
                    return 0;
                }

                if (specificBoom) {
                    return checkBoom(specificBoom);
                } else {
                    // Trouver la meilleure capacité sur toutes les flèches possibles
                    let maxCap = 0;
                    machine.boomLengths.forEach(len => {
                        const cap = checkBoom(len);
                        if (cap > maxCap) maxCap = cap;
                    });
                    return maxCap;
                }
            }
            else if (machine.mode === 'zone') {
                let foundLoad = 0;
                if (machine.zones) {
                    for (let zone of machine.zones) {
                        if (isPointInPolygon(dist, height, zone.points)) {
                            if (zone.load > foundLoad) foundLoad = zone.load;
                        }
                    }
                }
                return foundLoad;
            } 
            return 0;
        };

        // --- EXPORTS PDF / EXCEL ---
        const formatDateTime = () => {
            const now = new Date();
            return now.toISOString().slice(0,10).replace(/-/g,'') + '_' + now.toTimeString().slice(0,5).replace(':','');
        }

        const exportCraneExcel = (machine) => {
            if (!machine) return;
            const wb = XLSX.utils.book_new();
            let ws_data = [];

            if (machine.mode === 'multi_chart') {
                const boomLengths = machine.boomLengths;
                const header = ["Portée (m)", ...boomLengths.map(b => `Flèche ${b}m`)];
                ws_data.push(header);

                // Collect all radii
                let allRadii = new Set();
                boomLengths.forEach(len => {
                    if (machine.charts[len]?.std) {
                        machine.charts[len].std.forEach(p => allRadii.add(p.d));
                    }
                });
                const sortedRadii = Array.from(allRadii).sort((a,b) => a - b);

                sortedRadii.forEach(r => {
                    let row = [r];
                    boomLengths.forEach(len => {
                        const points = machine.charts[len]?.std || [];
                        const p = points.find(pt => Math.abs(pt.d - r) < 0.1);
                        row.push(p ? p.l : ""); 
                    });
                    ws_data.push(row);
                });
            } else if (machine.mode === 'zone') {
                ws_data = [["Zone ID", "Charge Max (kg)"]];
                machine.zones.forEach(z => {
                    ws_data.push([z.id, z.load]);
                });
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Abaque");
            XLSX.writeFile(wb, `${machine.name}_abaque_${formatDateTime()}.xlsx`);
        };

        const generateAdequacyPDF = (machine, inputLoad, inputDist, inputHeight, isSafe, safeLoad) => {
            if (!machine) return;
            const doc = new jsPDF();
            
            // Header Brand Blue
            doc.setFillColor(0, 78, 152); 
            doc.rect(0, 0, 210, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("ADÉQUATION DE LEVAGE", 105, 12, { align: "center" });
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Généré le : " + new Date().toLocaleString(), 105, 19, { align: "center" });

            let y = 40;

            // 1. Paramètres
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("1. PARAMÈTRES DE LA CHARGE", 14, y);
            y += 8;
            doc.autoTable({
                startY: y,
                head: [['Masse à lever', 'Portée (Rayon)', 'Hauteur']],
                body: [[`${inputLoad} kg`, `${inputDist} m`, `${inputHeight} m`]],
                theme: 'striped',
                headStyles: { fillColor: [0, 78, 152] }
            });
            y = doc.lastAutoTable.finalY + 15;

            // 2. Engin
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("2. ENGIN SÉLECTIONNÉ", 14, y);
            y += 8;
            doc.autoTable({
                startY: y,
                head: [['Modèle', 'Type', 'Capacité Max', 'Portée Max']],
                body: [[machine.name, machine.category, `${machine.maxLoad} kg`, `${machine.maxReach} m`]],
                theme: 'grid',
                headStyles: { fillColor: [100, 100, 100] }
            });
            y = doc.lastAutoTable.finalY + 15;

            // 3. Résultat
            doc.text("3. RÉSULTAT DU CALCUL", 14, y);
            y += 8;
            const status = isSafe ? "CONFORME / AUTORISÉ" : "NON CONFORME / INTERDIT";
            const color = isSafe ? [22, 163, 74] : [220, 38, 38];
            
            doc.autoTable({
                startY: y,
                head: [['Statut', 'Capacité à cette portée', 'Taux d\'utilisation']],
                body: [[status, `${safeLoad} kg`, `${Math.round((inputLoad/safeLoad)*100)} %`]],
                headStyles: { fillColor: color },
                styles: { fontSize: 12, fontStyle: 'bold' }
            });
            y = doc.lastAutoTable.finalY + 15;

            // 4. Conclusion
            doc.text("4. CONCLUSION", 14, y);
            y += 10;
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            
            const text = isSafe 
                ? "L'adéquation est VALIDÉE. L'engin sélectionné dispose de la capacité nécessaire pour effectuer la manœuvre en sécurité."
                : "L'adéquation est REFUSÉE. L'engin ne dispose pas de la capacité suffisante ou la configuration est hors abaque.";
            
            doc.text(doc.splitTextToSize(text, 180), 14, y);
            y += 30;

            doc.line(14, y, 196, y);
            y += 10;
            doc.text("Signature :", 14, y);

            doc.save(`${machine.name}_adequation_levage_${formatDateTime()}.pdf`);
        };

        const CMCLogo = () => (
            <svg width="220" height="50" viewBox="0 0 220 50" className="cursor-pointer">
                <g transform="translate(5, 5)">
                    <path d="M 10 0 L 30 0 L 40 10 L 40 18 L 0 18 L 0 10 Z" fill="#004e98" />
                    <path d="M 0 22 L 40 22 L 40 30 L 30 40 L 10 40 L 0 30 Z" fill="#d92e2e" />
                </g>
                <g transform="translate(55, 0)">
                    <text x="0" y="20" fontFamily="Arial, sans-serif" fontWeight="900" fontSize="18" fill="#004e98" letterSpacing="0.5">CHANTIERS</text>
                    <text x="0" y="36" fontFamily="Arial, sans-serif" fontWeight="900" fontSize="18" fill="#004e98" letterSpacing="0.5">MODERNES</text>
                    <text x="0" y="48" fontFamily="Arial, sans-serif" fontWeight="bold" fontSize="10" fill="#004e98" letterSpacing="1">CONSTRUCTION</text>
                </g>
            </svg>
        );

        // --- COMPOSANT SLIDER (Original conservé) ---
        const CustomRange = ({ label, value, min, max, step, onChange, unit = "", maxLabel = "" }) => {
            const range = max - min;
            const percentage = range > 0 ? ((value - min) / range) * 100 : 0;
            
            return (
                <div className="w-full">
                    <div className="flex justify-between items-end mb-2">
                        <label className="text-lg font-bold text-slate-700">{label}</label>
                        <span className="text-xl font-bold text-[#004e98]">{value} <span className="text-sm">{unit}</span></span>
                    </div>
                    <div className="relative w-full h-8">
                        <input type="range" min={min} max={max} step={step} value={value} onChange={onChange} className="absolute w-full h-full z-20 opacity-0 cursor-pointer" />
                        <div className="absolute top-1/2 left-0 w-full h-3 bg-slate-200 rounded-full -translate-y-1/2 overflow-hidden z-10 pointer-events-none">
                            <div style={{ width: `${percentage}%` }} className="h-full bg-[#004e98] transition-all duration-100 ease-out"></div>
                        </div>
                        <div style={{ left: `calc(${percentage}% - 12px)` }} className="absolute top-1/2 w-6 h-6 bg-[#004e98] border-2 border-white rounded-full shadow-md -translate-y-1/2 z-10 pointer-events-none transition-all duration-100 ease-out"></div>
                    </div>
                    <div className="flex justify-between text-xs text-slate-400 mt-1 font-medium">
                        <span>{min}{unit}</span>
                        <span>{maxLabel || `Max échelle : ${Math.round(max)}${unit}`}</span>
                    </div>
                </div>
            );
        };

        // --- MODAL GESTION BDD ---
        const DbManagerModal = ({ machines, onClose, onDelete, onReset, onImport }) => {
            const downloadJson = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(machines));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "cmc_levage_backup.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const imported = JSON.parse(evt.target.result);
                        if (Array.isArray(imported)) {
                            onImport(imported);
                        } else {
                            alert("Format JSON invalide.");
                        }
                    } catch (err) { alert("Erreur lecture fichier."); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 animate-slide-up">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold flex items-center gap-2"><Database className="text-[#004e98]"/> Gestion Base de Données Locale</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 font-bold text-xl">&times;</button>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="p-4 bg-blue-50 rounded-lg border border-blue-100 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-blue-100 transition" onClick={downloadJson}>
                                <Save size={32} className="text-blue-600 mb-2"/>
                                <span className="font-bold text-blue-800">Sauvegarder BDD</span>
                                <span className="text-xs text-blue-600">Exporter en .JSON</span>
                            </div>
                            <label className="p-4 bg-emerald-50 rounded-lg border border-emerald-100 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-emerald-100 transition">
                                <FileJson size={32} className="text-emerald-600 mb-2"/>
                                <span className="font-bold text-emerald-800">Restaurer BDD</span>
                                <span className="text-xs text-emerald-600">Importer un .JSON</span>
                                <input type="file" className="hidden" accept=".json" onChange={handleFileImport} />
                            </label>
                        </div>

                        <div className="mb-4">
                            <h4 className="font-bold text-slate-700 mb-2">Machines Enregistrées ({machines.length})</h4>
                            <div className="max-h-60 overflow-y-auto border border-slate-200 rounded-lg">
                                {machines.length === 0 ? (
                                    <div className="p-4 text-center text-slate-400 italic">Aucune machine personnalisée.</div>
                                ) : (
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 text-slate-500 font-bold sticky top-0">
                                            <tr><th className="p-3">Nom</th><th className="p-3">Type</th><th className="p-3 text-right">Action</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {machines.map(m => (
                                                <tr key={m.id} className="hover:bg-slate-50">
                                                    <td className="p-3 font-medium text-slate-700">{m.name}</td>
                                                    <td className="p-3 text-slate-500">{m.category}</td>
                                                    <td className="p-3 text-right">
                                                        <button onClick={() => onDelete(m.id)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Trash2 size={16}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>

                        <div className="flex justify-end gap-3 pt-4 border-t border-slate-100">
                            <button onClick={onReset} className="px-4 py-2 text-red-600 text-sm font-bold hover:bg-red-50 rounded-lg transition">Tout effacer</button>
                            <button onClick={onClose} className="px-6 py-2 bg-slate-800 text-white font-bold rounded-lg hover:bg-slate-900 transition">Fermer</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- HEADER ---
        const Header = ({ goHome }) => (
            <header className="bg-white border-b border-slate-200 px-4 py-3 sticky top-0 z-50 shadow-sm">
                <div className="max-w-7xl mx-auto flex items-center justify-between">
                    <div onClick={goHome} className="hover:opacity-80 transition-opacity"><CMCLogo /></div>
                    <div className="hidden md:flex items-center gap-2 text-xs text-emerald-700 font-bold bg-emerald-50 px-3 py-1.5 rounded-full border border-emerald-100">
                        <Database size={14} /> Mode Local (V9.0)
                    </div>
                </div>
            </header>
        );

        // --- PAGE ACCUEIL ---
        const HomePage = ({ navigate }) => (
            <div className="flex flex-col items-center justify-center min-h-[80vh] bg-slate-50 p-6 animate-fade-in">
                <div className="max-w-4xl w-full text-center space-y-12">
                    <div className="animate-slide-up" style={{animationDelay: '0.1s'}}>
                        <h1 className="text-4xl md:text-5xl font-extrabold text-slate-800 leading-tight">
                            Bienvenue sur le portail <br/>
                            <span className="text-[#004e98]">Levage Sécurisé</span>
                        </h1>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10 max-w-4xl mx-auto">
                        <button onClick={() => navigate('determine')} className="animate-slide-up group relative h-64 rounded-xl bg-[#004e98] text-white p-8 shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center gap-6" style={{animationDelay: '0.2s'}}>
                            <div className="p-4 bg-white/20 rounded-full group-hover:scale-110 transition-transform duration-300 backdrop-blur-sm"><Calculator size={48} /></div>
                            <div>
                                <span className="block text-2xl font-bold mb-2">Déterminer</span>
                                <span className="text-blue-100 text-lg font-light">le bon engin de levage</span>
                            </div>
                        </button>
                        
                        <button onClick={() => navigate('verify')} className="animate-slide-up group relative h-64 rounded-xl bg-[#004e98] text-white p-8 shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center gap-6" style={{animationDelay: '0.3s'}}>
                            <div className="p-4 bg-white/20 rounded-full group-hover:scale-110 transition-transform duration-300 backdrop-blur-sm"><CheckCircle size={48} /></div>
                            <div>
                                <span className="block text-2xl font-bold mb-2">Vérifier</span>
                                <span className="text-blue-100 text-lg font-light">mon engin de levage</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        );

        // --- PAGE CALCUL RAPIDE (DETERMINE) ---
        const DeterminePage = () => {
            const [mass, setMass] = useState(0);
            const [unit, setUnit] = useState('kg');
            const [distance, setDistance] = useState(0);
            const [height, setHeight] = useState(5); // Ajout d'une valeur par défaut réaliste
            const [progress, setProgress] = useState(0);
            const [result, setResult] = useState(null);
            const [suggestedCrane, setSuggestedCrane] = useState(null);

            // LOGIQUE DE RECHERCHE AUTO
            const performAutoSelect = (targetMassKg, targetDist, targetHeight) => {
                // 1. Charger toutes les machines (Hardcoded + LocalStorage)
                const saved = localStorage.getItem(DB_KEY);
                const localMachines = saved ? JSON.parse(saved) : [];
                const allMachines = [...HARDCODED_MACHINES, ...localMachines];

                const candidates = [];

                allMachines.forEach(m => {
                    const cap = calculateMachineCapacity(m, targetDist, targetHeight);
                    if (cap >= targetMassKg) {
                        candidates.push({ machine: m, capacity: cap, excess: cap - targetMassKg });
                    }
                });

                // Trier pour trouver le "meilleur" choix (capacité suffisante mais la plus petite possible)
                candidates.sort((a, b) => a.capacity - b.capacity);

                if (candidates.length > 0) {
                    const best = candidates[0].machine;
                    setSuggestedCrane(best);
                    localStorage.setItem(SELECTED_CRANE_KEY, JSON.stringify(best));
                } else {
                    setSuggestedCrane(null);
                    localStorage.removeItem(SELECTED_CRANE_KEY);
                }
            };

            useEffect(() => {
                if (mass > 0 && distance > 0) {
                    setProgress(0); setResult(null); setSuggestedCrane(null);
                    const interval = setInterval(() => {
                        setProgress(p => {
                            if (p >= 100) {
                                clearInterval(interval);
                                const massInTons = unit === 'kg' ? mass / 1000 : mass;
                                const massKg = unit === 'kg' ? mass : mass * 1000;
                                const moment = massInTons * distance;
                                setResult({ tons: massInTons, moment: moment.toFixed(1) });
                                
                                // Lancer la recherche auto ici
                                performAutoSelect(massKg, distance, height);
                                
                                return 100;
                            }
                            return p + 4;
                        });
                    }, 20);
                    return () => clearInterval(interval);
                } else { setResult(null); setProgress(0); setSuggestedCrane(null); }
            }, [mass, unit, distance, height]);

            return (
                <div className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 items-start min-h-[60vh] animate-fade-in">
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Calculator className="text-brand-blue"/> Paramètres de la charge</h2>
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-semibold text-slate-600 mb-2">Masse à soulever</label>
                                    <div className="flex gap-2">
                                        <input type="number" value={mass || ''} onChange={(e) => setMass(parseFloat(e.target.value))} className="flex-1 p-3 text-lg border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue outline-none transition-shadow" placeholder="0"/>
                                        <select value={unit} onChange={(e) => setUnit(e.target.value)} className="w-24 p-3 text-lg font-bold bg-slate-50 border border-slate-300 rounded-lg text-slate-700 cursor-pointer hover:bg-slate-100"><option value="kg">kg</option><option value="t">t</option></select>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-slate-600 mb-2">Portée (m)</label>
                                    <div className="relative">
                                        <input type="number" value={distance || ''} onChange={(e) => setDistance(parseFloat(e.target.value))} className="w-full p-3 text-lg border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue outline-none transition-shadow pl-4 pr-12" placeholder="0"/>
                                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">m</span>
                                    </div>
                                </div>
                                {/* NOUVEAU CHAMP HAUTEUR (Style identique) */}
                                <div>
                                    <label className="block text-sm font-semibold text-slate-600 mb-2">Hauteur (m) <span className="text-slate-400 text-xs font-normal">(Requis pour sélection auto)</span></label>
                                    <div className="relative">
                                        <input type="number" value={height || ''} onChange={(e) => setHeight(parseFloat(e.target.value))} className="w-full p-3 text-lg border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue outline-none transition-shadow pl-4 pr-12" placeholder="0"/>
                                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex flex-col gap-6">
                        <div className="flex flex-col items-center justify-center p-8 bg-white rounded-2xl shadow-lg border border-slate-100 min-h-[300px]">
                            {!result ? (
                                <div className="relative w-56 h-56">
                                    <svg className="w-full h-full transform -rotate-90">
                                        <circle cx="112" cy="112" r="100" stroke="#f1f5f9" strokeWidth="12" fill="transparent" />
                                        <circle cx="112" cy="112" r="100" stroke="#004e98" strokeWidth="12" fill="transparent" strokeDasharray={2 * Math.PI * 100} strokeDashoffset={2 * Math.PI * 100 - (progress / 100) * 2 * Math.PI * 100} className="transition-all duration-100 ease-linear" strokeLinecap="round"/>
                                    </svg>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                                        <span className="text-4xl font-bold text-slate-800">{progress}%</span>
                                        <span className="text-xs text-slate-400 uppercase tracking-widest mt-1">Calcul</span>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center w-full animate-slide-up">
                                    <div className="w-full bg-gradient-to-br from-blue-600 to-blue-800 text-white rounded-2xl p-8 mb-6 shadow-lg">
                                        <div className="text-blue-100 text-sm uppercase tracking-wide font-bold mb-2">Besoin Identifié</div>
                                        <div className="text-5xl font-extrabold mb-1">{result.tons} <span className="text-2xl opacity-80">t</span></div>
                                        <div className="text-xl opacity-90">à {distance} mètres</div>
                                    </div>
                                    <div className="grid grid-cols-1 gap-4">
                                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                            <div className="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">Moment de charge</div>
                                            <div className="text-3xl font-bold text-slate-800">{result.moment} <span className="text-sm text-slate-500 font-normal">t.m</span></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* RESULTAT AUTO */}
                        {result && (
                            <div className="animate-slide-up bg-slate-50 border border-slate-300 rounded-xl p-6">
                                <h3 className="text-sm font-bold text-slate-500 uppercase mb-4 flex items-center gap-2"><CheckCircle size={16}/> Recommandation Auto</h3>
                                {suggestedCrane ? (
                                    <div className="bg-white border border-green-200 rounded-xl p-4 shadow-sm relative overflow-hidden">
                                        <div className="absolute top-0 right-0 bg-green-500 text-white text-[10px] px-2 py-1 font-bold rounded-bl-lg">RECOMMANDÉ</div>
                                        <h4 className="text-lg font-bold text-slate-800 mb-1">{suggestedCrane.name}</h4>
                                        <p className="text-sm text-slate-500 mb-4">{suggestedCrane.category} • Max {suggestedCrane.maxLoad}kg</p>
                                        
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => exportCraneExcel(suggestedCrane)}
                                                className="flex-1 bg-green-50 hover:bg-green-100 text-green-700 text-xs font-bold py-2 px-3 rounded border border-green-200 flex items-center justify-center gap-1 transition-colors">
                                                <FileText size={14}/> Abaque Excel
                                            </button>
                                            <button 
                                                onClick={() => generateAdequacyPDF(suggestedCrane, (unit==='kg'?mass:mass*1000), distance, height, true, calculateMachineCapacity(suggestedCrane, distance, height))}
                                                className="flex-1 bg-red-50 hover:bg-red-100 text-red-700 text-xs font-bold py-2 px-3 rounded border border-red-200 flex items-center justify-center gap-1 transition-colors">
                                                <FileText size={14}/> PDF Adéquation
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center p-4 text-slate-500 italic text-sm">
                                        Aucun engin trouvé pour cette configuration.
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- PAGE VERIFICATION (AVEC LOCALSTORAGE & GRAPHIQUE) ---
        const VerifyPage = () => {
            const [dbMachines, setDbMachines] = useState([]);
            const [showDbManager, setShowDbManager] = useState(false);

            // Charger les données du LocalStorage au démarrage
            useEffect(() => {
                const saved = localStorage.getItem(DB_KEY);
                if (saved) {
                    try {
                        setDbMachines(JSON.parse(saved));
                    } catch (e) {
                        console.error("Erreur de lecture LocalStorage", e);
                    }
                }
            }, []);

            // Sauvegarder dans le LocalStorage
            const saveToLocal = (newMachines) => {
                setDbMachines(newMachines);
                localStorage.setItem(DB_KEY, JSON.stringify(newMachines));
            };

            const machines = useMemo(() => [...HARDCODED_MACHINES, ...dbMachines], [dbMachines]);

            const [category, setCategory] = useState('telehandler');
            const [selectedMachineId, setSelectedMachineId] = useState(null);
            const [inputLoad, setInputLoad] = useState(1000); 
            const [inputDist, setInputDist] = useState(5);    
            const [inputHeight, setInputHeight] = useState(2);
            const [selectedBoomLen, setSelectedBoomLen] = useState(0);
            const [isUploading, setIsUploading] = useState(false);

            // AUTO SELECTION AU CHARGEMENT si dispo dans localStorage
            useEffect(() => {
                const autoSelected = localStorage.getItem(SELECTED_CRANE_KEY);
                if (autoSelected) {
                    const m = JSON.parse(autoSelected);
                    const found = machines.find(x => x.id === m.id);
                    if (found) {
                        // Change category to match machine
                        setCategory(found.category);
                        setSelectedMachineId(found.id);
                        // Clean up selection so it doesn't override manual changes later
                        // localStorage.removeItem(SELECTED_CRANE_KEY); 
                    }
                }
            }, [machines]); // Run once when machines loaded

            const filteredMachines = useMemo(() => machines.filter(m => m.category === category), [machines, category]);

            useEffect(() => {
                if (filteredMachines.length > 0) { 
                    if (!selectedMachineId || !filteredMachines.find(m => m.id === selectedMachineId)) {
                        setSelectedMachineId(filteredMachines[0].id); 
                    }
                } 
                else { setSelectedMachineId(null); }
            }, [category, filteredMachines, selectedMachineId]);

            const machine = useMemo(() => machines.find(m => m.id === selectedMachineId) || filteredMachines[0], [selectedMachineId, machines, filteredMachines]);

            useEffect(() => {
                if (machine?.mode === 'multi_chart' && machine?.boomLengths) { setSelectedBoomLen(machine.boomLengths[0]); }
            }, [machine]);

            // Utilisation de la fonction externe
            const allowedLoad = calculateMachineCapacity(machine, inputDist, inputHeight, (machine?.mode === 'multi_chart' ? selectedBoomLen : null));
            const safeLoad = Math.floor(allowedLoad);
            const calculatedMax = safeLoad > 0 ? safeLoad * 1.1 : (machine ? machine.maxLoad : 5000);
            const finalMassSliderMax = Math.max(calculatedMax, 100);

            useEffect(() => {
                if (inputLoad > finalMassSliderMax) {
                    setInputLoad(Math.floor(finalMassSliderMax));
                }
            }, [finalMassSliderMax, inputLoad]);

            const isSafe = inputLoad <= safeLoad && safeLoad > 0;
            const usagePercent = safeLoad > 0 ? (inputLoad / safeLoad) * 100 : (inputLoad > 0 ? 110 : 0);

            // --- GESTION IMPORT EXCEL ---
            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        const headerRow = data[0];
                        const boomLengths = [];
                        const colToBoom = {};
                        for (let c = 1; c < headerRow.length; c++) {
                            const val = parseFloat(headerRow[c]);
                            if (!isNaN(val)) { boomLengths.push(val); colToBoom[c] = val; }
                        }
                        const charts = {};
                        boomLengths.forEach(len => charts[len] = { std: [] });
                        let maxLoadFound = 0; let maxReachFound = 0;
                        for (let r = 1; r < data.length; r++) {
                            const row = data[r];
                            const radius = parseFloat(row[0]);
                            if (!isNaN(radius)) {
                                if (radius > maxReachFound) maxReachFound = radius;
                                for (let c = 1; c < row.length; c++) {
                                    const loadVal = parseFloat(row[c]);
                                    const boomLen = colToBoom[c];
                                    if (boomLen && !isNaN(loadVal)) {
                                        charts[boomLen].std.push({ d: radius, l: loadVal });
                                        if (loadVal > maxLoadFound) maxLoadFound = loadVal;
                                    }
                                }
                            }
                        }
                        const newMachine = {
                            id: "custom_" + Date.now(),
                            category: category,
                            name: `${file.name.replace(/\.[^/.]+$/, "")}`,
                            type: "crane",
                            mode: "multi_chart",
                            maxLoad: maxLoadFound * 1000,
                            maxReach: maxReachFound,
                            maxHeight: Math.max(...boomLengths) + 2,
                            hasTelescoping: false,
                            boomLengths: boomLengths,
                            charts: charts,
                            createdAt: new Date().toISOString(),
                            isCustom: true
                        };
                        
                        // SAUVEGARDE LOCALE
                        const newDb = [...dbMachines, newMachine];
                        saveToLocal(newDb);
                        setSelectedMachineId(newMachine.id);
                        alert("Machine importée et sauvegardée localement !");

                    } catch (error) { alert("Erreur import: " + error.message); } finally { setIsUploading(false); e.target.value = null; }
                };
                reader.readAsBinaryString(file);
            };

            const downloadTemplate = () => {
                const ws_data = [["Portée(m) \\ Flèche(m)", 10, 20, 30, 40], [3, 50, 40, null, null], [10, 20, 18, 15, 12], [30, null, null, 4, 3]];
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Modele_Grue");
                XLSX.writeFile(wb, "Modele_Import_Grue.xlsx");
            };

            // --- ACTIONS MODAL ---
            const deleteCustomMachine = (id) => {
                if(confirm("Supprimer cette machine ?")) {
                    const newDb = dbMachines.filter(m => m.id !== id);
                    saveToLocal(newDb);
                    if(selectedMachineId === id) setSelectedMachineId(null);
                }
            };

            const resetDb = () => {
                if(confirm("ATTENTION : Cela va effacer toutes vos machines personnalisées. Continuer ?")) {
                    saveToLocal([]);
                    setSelectedMachineId(null);
                    setShowDbManager(false);
                }
            };

            const importDb = (importedMachines) => {
                if(confirm(`Importer ${importedMachines.length} machines ? Cela remplacera la base actuelle.`)) {
                    saveToLocal(importedMachines);
                    setShowDbManager(false);
                }
            }

            // --- GRAPHIQUE 2D (STRICTEMENT IDENTIQUE A L'ORIGINAL) ---
            const GraphChart2D = () => {
                if(!machine) return null;
                const width = 600;
                const height = 450;
                const padding = 50;
                const maxX = machine.maxReach * 1.1; 
                const maxY = machine.maxHeight * 1.1;
                const scaleX = (d) => padding + (d / maxX) * (width - 2 * padding);
                const scaleY = (h) => height - padding - (h / maxY) * (height - 2 * padding);
                const userX = scaleX(inputDist);
                const userY = scaleY(inputHeight);
                const gridStep = machine.category === 'telehandler' ? 1 : (maxX > 60 ? 10 : 5);

                return (
                <div className="w-full overflow-hidden rounded-xl border border-slate-300 bg-white shadow-sm relative">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto">
                        <defs>
                            <pattern id="grid" width={scaleX(gridStep) - scaleX(0)} height={scaleY(0) - scaleY(gridStep)} patternUnits="userSpaceOnUse">
                                <path d={`M ${scaleX(gridStep) - scaleX(0)} 0 L 0 0 0 ${scaleY(0) - scaleY(gridStep)}`} fill="none" stroke="#f1f5f9" strokeWidth="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="white"/>
                        <rect x={padding} y={padding} width={width-2*padding} height={height-2*padding} fill="url(#grid)" />
                        <line x1={padding} y1={height-padding} x2={width-padding} y2={height-padding} stroke="#334155" strokeWidth="2" />
                        <line x1={padding} y1={padding} x2={padding} y2={height-padding} stroke="#334155" strokeWidth="2" />
                        {Array.from({ length: Math.ceil(maxX / gridStep) + 1 }).map((_, i) => {
                            const val = i * gridStep;
                            if (val > maxX) return null;
                            return <text key={`x${i}`} x={scaleX(val)} y={height - padding + 20} fontSize="10" textAnchor="middle" fill="#64748b">{val}</text>;
                        })}
                        {Array.from({ length: Math.ceil(maxY / gridStep) + 1 }).map((_, i) => {
                            const val = i * gridStep;
                            if (val > maxY) return null;
                            return <text key={`y${i}`} x={padding - 10} y={scaleY(val) + 3} fontSize="10" textAnchor="end" fill="#64748b">{val}</text>;
                        })}
                        {machine.mode === 'zone' && machine.zones.map(z => (
                            <g key={z.id}>
                                <path d={`M ${scaleX(z.points[0][0])} ${scaleY(z.points[0][1])}` + z.points.slice(1).map(p => ` L ${scaleX(p[0])} ${scaleY(p[1])}`).join("") + " Z"} fill={z.color} stroke={z.borderColor || 'none'} strokeWidth="1" />
                                <text x={scaleX((z.points[0][0] + z.points[2][0])/2)} y={scaleY((z.points[0][1] + z.points[4][1])/2)} fontSize="10" fontWeight="bold" fill="#fff" textAnchor="middle" opacity="0.9">{z.load}kg</text>
                            </g>
                        ))}
                        {machine.mode === 'multi_chart' && machine.boomLengths.map(len => (
                            <path key={len} d={`M ${scaleX(0)} ${scaleY(len)} A ${scaleX(len)-scaleX(0)} ${scaleY(0)-scaleY(len)} 0 0 1 ${scaleX(len)} ${scaleY(0)}`} fill="none" stroke={len===selectedBoomLen ? "#0f172a" : "#cbd5e1"} strokeWidth={len===selectedBoomLen ? "2" : "1"} strokeDasharray={len===selectedBoomLen ? "" : "4 2"}/>
                        ))}
                        <line x1={scaleX(0)} y1={scaleY(0)} x2={userX} y2={userY} stroke={isSafe ? "#16a34a" : "#dc2626"} strokeWidth="3" opacity="0.6" />
                        <line x1={userX} y1={userY} x2={userX} y2={height-padding} stroke={isSafe ? "#16a34a" : "#dc2626"} strokeWidth="1" strokeDasharray="4 2" />
                        <circle cx={userX} cy={userY} r="8" fill={isSafe ? "#22c55e" : "#ef4444"} stroke="white" strokeWidth="3" className="transition-all duration-300 ease-out" />
                        <text x={width/2} y={height-10} textAnchor="middle" fontSize="12" fontWeight="600" fill="#334155">Portée (m)</text>
                        <text x={15} y={height/2} textAnchor="middle" transform={`rotate(-90, 15, ${height/2})`} fontSize="12" fontWeight="600" fill="#334155">Hauteur (m)</text>
                    </svg>
                    <div className={`absolute top-4 right-4 px-3 py-1 rounded-full text-xs font-bold border shadow-sm ${isSafe ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200'}`}>
                        {isSafe ? 'ZONE SÉCURISÉE' : 'ZONE INTERDITE'}
                    </div>
                </div>
                );
            };

            return (
                <div className="space-y-6 max-w-7xl mx-auto pb-12 animate-fade-in">
                    
                    {/* MENU GESTION BDD */}
                    {showDbManager && <DbManagerModal machines={dbMachines} onClose={() => setShowDbManager(false)} onDelete={deleteCustomMachine} onReset={resetDb} onImport={importDb}/>}

                    <div className="flex flex-wrap justify-center gap-3 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                        {[{id: 'telehandler', label: 'Engin Télescopique', icon: Truck}, {id: 'mobile_crane', label: 'Grue Mobile', icon: Move}, {id: 'crawler_crane', label: 'Grue Treillis', icon: Anchor}].map(cat => (
                            <button key={cat.id} onClick={() => setCategory(cat.id)} className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-sm transition-all ${category === cat.id ? 'bg-[#004e98] text-white shadow-md' : 'bg-transparent text-slate-500 hover:bg-slate-50'}`}>
                                <cat.icon size={18} /> {cat.label}
                            </button>
                        ))}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-4 space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-1 h-full bg-[#004e98]"></div>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2"><Truck size={18} className="text-[#004e98]"/> Choix de l'engin</h3>
                                    <button onClick={() => setShowDbManager(true)} className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 flex items-center gap-1"><Database size={12}/> Gérer BDD</button>
                                </div>
                                
                                <div className="flex gap-2 mb-4">
                                    <select value={selectedMachineId || ''} onChange={(e) => setSelectedMachineId(e.target.value)} className="flex-1 p-3 border border-slate-300 rounded-lg bg-slate-50 text-sm font-semibold focus:ring-2 focus:ring-[#004e98] outline-none">
                                        {filteredMachines.map(m => <option key={m.id} value={m.id}>{m.name} {m.isCustom ? "(Local)" : ""}</option>)}
                                    </select>
                                </div>

                                {/* BOUTONS NOUVEAUX : EXCEL ET PDF */}
                                {machine && (
                                    <div className="flex gap-2 mb-4">
                                        <button 
                                            onClick={() => exportCraneExcel(machine)}
                                            className="flex-1 bg-slate-50 hover:bg-slate-100 text-slate-700 text-xs font-bold py-2 px-2 rounded border border-slate-200 flex items-center justify-center gap-1 transition-colors">
                                            <FileText size={14}/> Abaque .xlsx
                                        </button>
                                        <button 
                                            onClick={() => generateAdequacyPDF(machine, inputLoad, inputDist, inputHeight, isSafe, safeLoad)}
                                            className="flex-1 bg-slate-50 hover:bg-slate-100 text-slate-700 text-xs font-bold py-2 px-2 rounded border border-slate-200 flex items-center justify-center gap-1 transition-colors">
                                            <FileText size={14}/> Rapport .pdf
                                        </button>
                                    </div>
                                )}

                                <div className="bg-blue-50 rounded-lg p-4 border border-blue-100">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-xs font-bold text-blue-800 flex items-center gap-1"><Database size={12}/> Import Local</span>
                                        <button onClick={downloadTemplate} className="text-[10px] text-blue-600 underline flex items-center gap-1 hover:text-blue-800"><Download size={10}/> Modèle .xlsx</button>
                                    </div>
                                    <label className="flex flex-col items-center justify-center w-full h-20 border-2 border-blue-200 border-dashed rounded-lg cursor-pointer hover:bg-blue-100 transition-colors">
                                        {isUploading ? <span className="text-xs font-bold text-blue-600 animate-pulse">Traitement...</span> : (
                                            <>
                                                <Upload size={20} className="text-blue-400 mb-1" />
                                                <span className="text-[10px] text-blue-500 font-semibold">Glisser fichier Excel</span>
                                            </>
                                        )}
                                        <input type="file" accept=".xlsx,.xls" className="hidden" onChange={handleExcelUpload} disabled={isUploading} />
                                    </label>
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><Calculator size={18} className="text-[#004e98]"/> Configuration de Levage</h3>
                                <div className="space-y-6">
                                    {machine && machine.mode === 'multi_chart' && (
                                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                            <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Longueur Flèche (m)</label>
                                            <div className="flex flex-wrap gap-2">
                                                {machine.boomLengths.map(len => (
                                                    <button key={len} onClick={() => setSelectedBoomLen(len)} className={`px-3 py-1 text-xs font-bold rounded shadow-sm transition-all ${selectedBoomLen === len ? 'bg-slate-800 text-white transform scale-105' : 'bg-white text-slate-600 hover:bg-slate-200'}`}>
                                                        {len}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    <CustomRange label="Masse (t)" value={inputLoad/1000} min={0} max={finalMassSliderMax/1000} step={0.05} unit="t" onChange={(e) => setInputLoad(Math.round(parseFloat(e.target.value)*1000))} />
                                    <CustomRange label="Portée (m)" value={inputDist} min={0} max={machine?.maxReach + 2} step={0.5} unit="m" onChange={(e) => setInputDist(parseFloat(e.target.value))} />
                                    <CustomRange label="Hauteur Crochet (m)" value={inputHeight} min={0} max={machine?.maxHeight + 2} step={0.5} unit="m" onChange={(e) => setInputHeight(parseFloat(e.target.value))} />
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-8 space-y-6">
                            <div className={`relative rounded-xl overflow-hidden shadow-sm flex flex-col md:flex-row ${isSafe ? 'bg-[#ecfdf5]' : 'bg-red-50'}`}>
                                <div className={`absolute left-0 top-0 bottom-0 w-3 ${isSafe ? 'bg-[#10b981]' : 'bg-red-500'}`}></div>
                                <div className="p-6 pl-9 flex-1 flex flex-col">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h2 className={`text-2xl font-bold uppercase mb-1 ${isSafe ? 'text-[#065f46]' : 'text-red-800'}`}>{isSafe ? 'AUTORISÉ' : 'INTERDIT'}</h2>
                                            <p className="text-slate-600 font-medium">{isSafe ? 'Configuration conforme' : 'Capacité dépassée ou hors de portée'}</p>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-4xl font-bold text-slate-800">{safeLoad/1000} <span className="text-xl font-semibold">t</span></div>
                                            <div className="text-xs text-slate-500 mt-1">Max Autorisé à {inputDist}m</div>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-8">
                                        <div className="flex gap-2 items-end mb-2">
                                            <span className="text-sm font-bold text-black">Utilisation {Math.round(usagePercent)}%</span>
                                        </div>
                                        <div className="w-full h-4 bg-slate-200 rounded-full overflow-hidden">
                                            <div style={{width: `${Math.min(100, usagePercent)}%`}} className={`h-full rounded-full transition-all duration-500 ease-out ${isSafe ? 'bg-[#10b981]' : 'bg-red-500'}`}></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <GraphChart2D />
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('home');
            return (
                <div className="min-h-screen">
                    <Header goHome={() => setPage('home')} />
                    <main className="p-4 md:p-8 max-w-[1600px] mx-auto">
                        {page === 'home' && <HomePage navigate={setPage} />}
                        {page !== 'home' && (
                            <div className="animate-fade-in">
                                <button onClick={() => setPage('home')} className="mb-6 flex items-center text-slate-500 hover:text-brand-blue font-bold px-4 py-2 hover:bg-white rounded-lg transition-colors">
                                    <ArrowLeft size={20} className="mr-2"/> Retour Accueil
                                </button>
                                {page === 'determine' && <DeterminePage />}
                                {page === 'verify' && <VerifyPage />}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

